version: '3.4'

services:

  internal-rabbit-node-1:
    image: komgo/rabbitmq-cluster
    build:
      context: ./komgo-member-mq/config
      dockerfile: Dockerfile.dev
    container_name: komgo-member-${MEMBER_ID}-internal-mq-node-1
    hostname: ${INTERNAL_MQ_HOST}
    environment:
      - ERLANG_COOKIE=abcdefg
    volumes:
      - ${PWD}/komgo-member-mq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
      - ${PWD}/komgo-member-mq/config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ${PWD}/komgo-member-mq/config/rabbitmq-cluster:/usr/local/bin/rabbitmq-cluster:ro
      - ./.db/rabbitmqdata/internal-member-${MEMBER_ID}-node1:/var/lib/rabbitmq/mnesia
    ports:
      - ${PORT_1:-5672}:5672
      - ${PORT_2:-15672}:15672

  # In order to have more nodes within the cluster, add snippets like this changing ports mapping, service name and hostname
  internal-rabbit-node-2:
    image: komgo/rabbitmq-cluster
    build:
      context: ./komgo-member-mq/config
      dockerfile: Dockerfile.dev
    container_name: komgo-member-${MEMBER_ID}-internal-mq-node-2
    hostname: komgo-member-${MEMBER_ID}-internal-mq-node-2
    links:
      - internal-rabbit-node-1
    environment:
      - ERLANG_COOKIE=abcdefg
      - CLUSTER_WITH=${INTERNAL_MQ_HOST}
      - ENABLE_RAM=true
    volumes:
      - ${PWD}/komgo-member-mq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
      - ${PWD}/komgo-member-mq/config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ${PWD}/komgo-member-mq/config/rabbitmq-cluster:/usr/local/bin/rabbitmq-cluster:ro
      - ./.db/rabbitmqdata/internal-member-${MEMBER_ID}-node2:/var/lib/rabbitmq/mnesia

  # We run this service in order to create the admin user once the bootstrap node of the cluster (komgo-internal-mq-node-1) is up and running
  configure-dev-internal:
    build:
      context: ./komgo-member-mq/config
      dockerfile: Dockerfile.create.admin
    container_name: komgo-member-${MEMBER_ID}-internal-mq-config
    restart: on-failure
    environment:
      - MQ_NODE_HOST=${INTERNAL_MQ_HOST}
      - MQ_NODE_PORT=15672
      - ADMIN=${INTERNAL_MQ_USERNAME}
      - PW_SEED=${INTERNAL_MQ_PASSWORD}
    volumes:
      - ${PWD}/komgo-member-mq/config/wait-for-it:/usr/local/bin/wait-for-it:ro
      - ${PWD}/komgo-member-mq/config/create-admin:/usr/local/bin/create-admin:ro
      - ${PWD}/komgo-member-mq/config/password-hash-gen:/usr/local/bin/password-hash-gen:ro
    command: >
      bash -c "wait-for-it $INTERNAL_MQ_HOST:15672 && create-admin"

networks:
  default:
    external:
      name: komgo-${MEMBER_ID}
