version: '3.4'

services:


  # DUMMY NODE TO TEST VAKT SHOVELS:
  vakt-rabbit-node-1:
    image: komgo/rabbitmq-cluster
    build:
      context: ./komgo-member-mq/config
      dockerfile: Dockerfile.dev
    container_name: komgo-vakt-mq-node-1
    hostname: ${VAKT_MQ_HOST}
    environment:
      - ERLANG_COOKIE=abcdefg
    volumes:
      - ${PWD}/komgo-member-mq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
      - ${PWD}/komgo-member-mq/config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ${PWD}/komgo-member-mq/config/rabbitmq-cluster:/usr/local/bin/rabbitmq-cluster:ro
      - ./.db/rabbitmqdata/vakt-node1:/var/lib/rabbitmq/mnesia
    ports:
      - 5674:5672
      - 15674:15672

  # In order to have more nodes within the cluster, add snippets like this changing ports mapping, service name and hostname
  vakt-rabbit-node-2:
    image: komgo/rabbitmq-cluster
    build:
      context: ./komgo-member-mq/config
      dockerfile: Dockerfile.dev
    container_name: komgo-vakt-mq-node-2
    hostname: komgo-vakt-mq-node-2
    links:
      - vakt-rabbit-node-1
    environment:
      - ERLANG_COOKIE=abcdefg
      - CLUSTER_WITH=${VAKT_MQ_HOST}
      - ENABLE_RAM=true
    volumes:
      - ${PWD}/komgo-member-mq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
      - ${PWD}/komgo-member-mq/config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ${PWD}/komgo-member-mq/config/rabbitmq-cluster:/usr/local/bin/rabbitmq-cluster:ro
      - ./.db/rabbitmqdata/vakt-node2:/var/lib/rabbitmq/mnesia

  # We run this service in order to create the admin user once the bootstrap node of the cluster (komgo-internal-mq-node-1) is up and running
  configure-dev-vakt:
    build:
      context: ./komgo-member-mq/config
      dockerfile: Dockerfile.create.admin
    container_name: komgo-vakt-configure-dev
    environment:
      - MQ_NODE_HOST=${VAKT_MQ_HOST}
      - MQ_NODE_PORT=15672
      - ADMIN=${VAKT_MQ_USERNAME}
      - PW_SEED=${VAKT_MQ_PASSWORD}
    volumes:
      - ${PWD}/komgo-member-mq/config/wait-for-it:/usr/local/bin/wait-for-it:ro
      - ${PWD}/komgo-member-mq/config/create-admin:/usr/local/bin/create-admin:ro
      - ${PWD}/komgo-member-mq/config/password-hash-gen:/usr/local/bin/password-hash-gen:ro
      - ${PWD}/komgo-member-mq/config/setup-member:/usr/local/bin/setup-member:ro
    command: >
      bash -c "wait-for-it $VAKT_MQ_HOST:15672 && create-admin"

networks:
  default:
    external:
      name: komgo
